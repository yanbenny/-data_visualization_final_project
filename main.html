<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My test page</title>
    <style>
        path {
            stroke: #777;
            stroke-width: .5px;
        }

        circle {
            stroke: #111;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 4px;
        }

        #menu {
            top: 20px;
            left: 30px;
            height: 350px;
            width: 250px;
            float: left;
            margin-right: 30px;
            margin-left: 10px;
        }

        #menu .item input {
            width: 100px;
        }

        #map {
            float: left;
            width: 600px;
            height: 650px;
            background-color: white;
            border-style: groove;
        }

        #chart {
            width: 450px;
            float: left;

        }

        #line_chart {
            width: 400px;
            height: 310px;

        }

        #bar_chart {
            width: 450px;
            height: 300px;
        }

        #selector {
            border-top: 1px solid #d3d3d5;
            margin-top: 0px;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 12px;
            color: #333;
            margin: 10px;
        }

        .title {
            font-weight: 700;
            font-size: 20px;
            line-height: 1;
            padding-bottom: 14px;
            border-bottom: 1px solid #d3d3d5;
        }

        .MRT {
            stroke: #777;
            stroke-width: 3px;
            fill: white;
        }

        .item {
            height: 140px;
            margin: 5px;
            border-bottom: 2px solid #d3d3d5;
        }

        #time_b {
            visibility: hidden;
        }

        .bar_chart_mouseover {
            stroke: #111;
            stroke-width: 0.2em;
            stroke-linecap: round;
        }
        div.detail {
            position: absolute;
            text-align: center;
            width: 200px;
            height: 200px;
            padding: 2px;
            font: 30px sans-serif;
            background:white;
            border:5px black solid;
            border-radius: 8px;
            pointer-events: none;
        }
        div.hint {
            position: absolute;
            text-align: center;
            width: 70px;
            height: 40px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>

</head>

<body>
    <div style="height: 20px;"></div>
    <div id="menu">

        <div class="title">Filter</div>
        
        <div id="selector">
            <div id="time_a" class="item">
                <label>開始日期</label>
                <div>
                    <select name="s_y_a" class="form-control" style="width: 80px;float: left;">
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option selected value="2019">2019</option>
                        <option value="2020">2020</option>
                    </select>
                    <select name="s_m_a" class="form-control" style="width: 80px;float: left;">
                        <option selected value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <select name="s_d_a" class="form-control" style="width: 80px;">
                        <option selected value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                    </select>
                </div>
                <label style="margin-top:8px;">結束日期</label>
                <div>
                    <select name="e_y_a" class="form-control" style="width: 80px;float: left;">
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option selected value="2020">2020</option>
                    </select>
                    <select name="e_m_a" class="form-control" style="width: 80px;float: left;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option selected value="12">12</option>
                    </select>
                    <select name="e_d_a" class="form-control" style="width: 80px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option selected value="31">31</option>
                    </select>
                </div>
            </div>
            <div class="checkbox">
                <label>
                    <input id="show_status" type="checkbox"> 啟用對比
                </label>
            </div>
            <div id="time_b" class="item">
                <div class="title">對比數據</div>
                <label>開始日期</label>
                <div>
                    <select name="s_y_b" class="form-control" style="width: 80px;float: left;">
                        <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                    </select>
                    <select name="s_m_b" class="form-control" style="width: 80px;float: left;">
                        <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <select name="s_d_b" class="form-control" style="width: 80px;">
                        <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                    </select>
                </div>
                <label style="margin-top:8px;">結束日期</label>
                <div>
                    <select name="e_y_b" class="form-control" style="width: 80px;float: left;">
                        <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                    </select>
                    <select name="e_m_b" class="form-control" style="width: 80px;float: left;">
                        <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <select name="e_d_b" class="form-control" style="width: 80px;">
                        <option selected="selected" disabled="disabled" style='display: none' value=''></option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                    </select>
                </div>
            </div>

            <!--
            <div class="slider item">
                <div class="label">scale (<span class="value">28000</span>)</div>
                <div><span class="low">0</span> <input type="range" name="scale" min="25000" max="200000" value="28000">
                    <span>100</span></div>
            </div>
            <div class="slider item">
                <div class="label">longitude (<span class="value">122.1</span>)</div>
                <div><span class="low">0</span> <input type="range" name="longitude" min="0" max="100" value="50">
                    <span>100</span></div>
            </div>
            <div class="slider item">
                <div class="label">latitude (<span class="value">25.0</span>)</div>
                <div><span class="low">0</span> <input type="range" name="latitude" min="0" max="100" value="50">
                    <span>100</span></div>
            </div>
            -->
        </div>

    </div>
    <div id="map"></div>
    <div id="chart">
        <div class="title" style="margin-left: 10px;" id="line_chart_id">運量折線圖</div>
        <div id="line_chart"></div>
        <div class="title" style="margin-left: 10px" ;>總運量</div>
        <div id="bar_chart"></div>
    </div>
    <script>
        var position, map;
        var MRT_record;
        var station_name;
        var station;

        var time_key;
        var days;
        var start_time_array_a = [2019, 1, 1];
        var end_time_array_a = [2020, 12, 31];

        var start_time_array_b = [0, 0, 0];
        var end_time_array_b = [0, 0, 0];

        var start_time_a = '2019/1/1';
        var end_time_a = '2020/12/31';

        var data_a = {};
        var data_b = {};
        
        var compare_rate = {};


        /*
        var color = ['#007500', '#28FF28', '#A6FFA6', '#F0FFF0',
            '#FFB5B5', '#FF5151', '#ff0f0f', '#750000', '#800080']*/

        var color = ['#007500', '#28FF28', '#A6FFA6', '#F0FFF0',
            '#FFB5B5', '#FF5151','#800080']

        var special_color = '#800080';

        var use_compare = false;
        var click_status = false;

        var state = {
            longitude: 121.581,
            latitude: 25.09,
            scale: 150000
        }

        var width = 600, height = 650;
        var projection = d3.geoMercator().center([state['longitude'], state['latitude']]).scale(state['scale']);
        var path = d3.geoPath().projection(projection);
        
        const zoom = d3.zoom().scaleExtent([1, 35]).on("zoom", zoomed);

    
        var svg = d3.select("#map").append("svg").attr("width", width).attr("height", height).on("click", reset);
        var g = svg.append("g");

        svg.call(zoom)

        var hint = d3.select("body").append("div").attr("class", "hint").style("opacity", 0);
        var detail = d3.select("body").append("div").attr("class","detail").style("opacity", 0);

        g.selectAll("rect").data(color).enter().append("rect").attr("fill",(d)=>{return d}).attr('height', '15').attr('width',20)
            .attr('x',(d)=>{
                return 400+ color.indexOf(d)*20
        }).attr('y',30).attr('stroke','#111')

        g.append('text').text('少').attr("x",400).attr("y",60)
        g.append('text').text('多').attr("x",520).attr("y",60)
       
        
            
        


        

        var margin = { top: 20, right: 20, bottom: 60, left: 60 };
        var population;
        var line_chart_width = 450 - margin.left - margin.right;
        var line_chart_height = 300 - margin.top - margin.bottom;

        var x = d3.scaleTime().range([0, line_chart_width]);
        var y = d3.scaleLinear().range([line_chart_height, 0]);

        var line_chart = d3.select('#line_chart').append("svg").attr("width", 450).attr("height", 300);
        var bar_chart = d3.select('#bar_chart').append("svg").attr("width", 450).attr("height", 300);

        line_chart.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        bar_chart.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var valueline = d3.line().x(function (d) { return x(d.date); }).y(function (d) { return y(d.count); });

        function reset(){
            click_status = false
            detail.style("opacity", 0);
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity,
                d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
            );
        }

        function clicked(station_name, x, y,pageX,pageY) {
            click_status = true;

            let index;
            let result = "";

            for(var i = 0 ; i <population.length ; i++){
                if(population[i].station ==station_name){
                    index = i+1;
                    break;
                }
            }
            
            
            if(use_compare){
                if(compare_rate[station_name]>1){
                    result = "日運量比較:上升" + Math.floor((compare_rate[station_name]-1)*100) + "%";
                }
                else{
                    result = "日運量比較:下降" + Math.floor((1-compare_rate[station_name])*100) + "%";
                }
                console.log(compare_rate[station_name]);
            }
            event.stopPropagation();
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(width / 2, height / 2).scale(40).translate(-x, -y),
                d3.mouse(svg.node())
            );
            setTimeout(() => {
                detail.style("opacity", 1);
                detail.html(
                    station_name + "<div style='font-size:20px;text-align:left;' >日運量:"+ Math.floor(population[index].population/days * 100) / 100 + "<br/> 運量排名:" + index + "/" + population.length + "<br/>"+ result+ "</div>")
                .style("left", (490) + "px")
                .style("top", (250) + "px");

            },1000)
        }
        function zoomed() {
             g.attr("transform", d3.event.transform);
        }
        function clear(str) {
            str = str.replace(/,/g, "");
            return str;
        }
        function update() {
            //update start time and end time
            start_time_a = start_time_array_a[0] + '/' + start_time_array_a[1] + '/' + start_time_array_a[2];
            end_time_a = end_time_array_a[0] + '/' + end_time_array_a[1] + '/' + end_time_array_a[2];
            start_time_b = start_time_array_b[0] + '/' + start_time_array_b[1] + '/' + start_time_array_b[2];
            end_time_b = end_time_array_b[0] + '/' + end_time_array_b[1] + '/' + end_time_array_b[2];

            if (use_compare) {
                if (start_time_b[0] && start_time_b[1] && start_time_b[2] && end_time_array_b[0] && end_time_array_b[1] && end_time_array_b[2]) {
                    compute_compare()
                }
                else {
                    console.log('還有空')
                }
            }
            else {
                compute()
            }
        }
        
        function update_compare_map(day_a,day_b) {
            var rate = {}
            
    
            for (var k in data_a) {
                rate[k] = (data_a[k]/day_a) / (data_b[k]/day_b);
            }

            compare_rate = rate;
            for (var k in rate) {
                d3.selectAll('#' + k).attr('fill', function () {
                    if (isFinite(rate[k])) {
                        if(rate[k]>1){
                            let v = rate[k] - 1;
                            if(v<0.02){
                                return color[3]
                            }
                            else if(v<0.05){
                                return color[4];
                            }
                            else if(v<0.08){
                                return color[5];
                            }
                            else{
                                return color[6];
                            }
                        }
                        else
                        {
                            let v = 1 - rate[k] ;
                            if(v<0.02){
                                return color[3]
                            }
                            else if(v<0.05){
                                return color[2];
                            }
                            else if(v<0.08){
                                return color[1];
                            }
                            else{
                                return color[0];
                            }
                        }
                    }
                    else {
                        return '#000000'
                    }
                })
            }
        }
        function update_map(min, max, average) {

            let b_step = (max - average) / 4;
            let s_step = (average - min) / 4;



            for (var k in data_a) {

                d3.selectAll('#' + k).attr('fill', function () {
                    if (!data_a[k]) {
                        return '#000000'
                    }
                    else if (data_a[k] > average) {
                        let index = parseInt((data_a[k] - average) / b_step);

                        if (index > 3) {
                            return special_color
                        }
                        return color[4 + parseInt((data_a[k] - average) / b_step)];
                    }
                    else if (data_a[k] <= average) {
                        //console.log(parseInt((data_a[k] - min) / s_step))
                        return color[parseInt((data_a[k] - min) / s_step)];
                    }

                })
            }
        }
        function compute_compare() {
            var start_index_a = time_key.indexOf(start_time_a);
            var end_index_a = time_key.indexOf(end_time_a);
            
            var start_index_b = time_key.indexOf(start_time_b);
            var end_index_b = time_key.indexOf(end_time_b);

            var day_a = end_index_a - start_index_a;
            var day_b = end_index_b - start_index_b;

            days = day_a
            //console.log(start_index_a, end_index_a, start_index_b, end_index_b)

            station_name.forEach(element => {
                data_a[element] = 0;
                data_b[element] = 0;
            });
            //compute a sum
            for (var i = start_index_a; i < end_index_a; i++) {
                for (var k in MRT_record[time_key[i]]) {
                    v = parseInt(clear(MRT_record[time_key[i]][k]))
                    if (isNaN(v)) {
                        data_a[k] += 0;
                    }
                    else {
                        data_a[k] += v;
                    }
                }
            }
            //compute b sum
            for (var i = start_index_b; i < end_index_b; i++) {
                for (var k in MRT_record[time_key[i]]) {
                    v = parseInt(clear(MRT_record[time_key[i]][k]))
                    if (isNaN(v)) {
                        data_b[k] += 0;
                    }
                    else {
                        data_b[k] += v;
                    }
                }
            }

            
            update_compare_map(day_a,day_b);

        }
        function compute() {
            //compute data_a to update map
            var start_index = time_key.indexOf(start_time_a);
            var end_index = time_key.indexOf(end_time_a);

            days = end_index -  start_index;
            
            station_name.forEach(element => {
                data_a[element] = 0;
                data_b[element] = 0;
            });

            var i;
            var v;
            for (i = start_index; i < end_index; i++) {
                for (var k in MRT_record[time_key[i]]) {
                    //console.log();
                    v = parseInt(clear(MRT_record[time_key[i]][k]))
                    if (isNaN(v)) {
                        data_a[k] += 0;
                    }
                    else {
                        data_a[k] += v;
                    }
                }
            }
            var min = data_a['蘆洲']
            var max = data_a['蘆洲']

            var sum = 0;
            var ii = 0
            for (var k in data_a) {
                if (data_a[k] > max) {
                    max = data_a[k];
                }
                else if (data_a[k] < min) {
                    min = data_a[k]
                }
                sum += data_a[k];
            }
            console.log(ii);
            update_map(min, max, sum / 119);
            update_bar_chart();
        }
        function transform() {
            //改變原本的資料
            let r = {};
            let date;
            station_name = MRT_record.columns;
            station_name.shift()

            MRT_record.forEach(element => {
                date = element.車站日期;
                delete element['車站日期'];
                r[date] = element
            });
            MRT_record = r;
            time_key = Object.keys(MRT_record);
        }
        function update_line_chart(station_name) {
            d3.select("#line_chart_id").text(station_name + "站運量")

            line_chart.remove()
            line_chart = d3.select('#line_chart').append("svg").attr("width", 450).attr("height", 350);
            line_chart_g = line_chart.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var parseTime = d3.timeParse("%d-%b-%y");

            var start_index_a = time_key.indexOf(start_time_a);
            var end_index_a = time_key.indexOf(end_time_a);

            var data = [];


            for (var i = start_index_a; i < end_index_a; i++) {
                var a = {};
                a['date'] = new Date(time_key[i]);
                a['count'] = parseInt(clear(MRT_record[time_key[i]][station_name]));
                data.push(a);
            }

            x.domain(d3.extent(data, function (d) { return d.date; }));
            y.domain([0, d3.max(data, function (d) { return d.count; })]);
            var has_circle = false
            var dot
            line_chart_g.append("path").data([data]).attr("class", "line").attr("d", valueline).on("click", function (d) {
                if (has_circle) {
                    dot.remove()
                    has_circle = false
                }
                else {
                    has_circle = true
                    dot = line_chart_g.selectAll("dot").data(data).enter().append("circle").attr("r", 5)
                        .attr("cx", function (d) { return x(d.date); })
                        .attr("cy", function (d) { return y(d.count); })
                        .on("mouseover", function (d) {
                            hint.style("opacity", .9);
                            hint.html(d3.timeFormat("%Y/%m/%d")(d.date) + "<br/>" + d.count)
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                        })
                        .on("mouseout", function (d) {
                            hint.transition()
                                .duration(500)
                                .style("opacity", 0);
                        });
                }
            });




            line_chart_g.append("g").attr("class", "axis").attr("transform", "translate(0," + line_chart_height + ")").call(d3.axisBottom(x)
                .tickFormat(d3.timeFormat("%Y-%m-%d")))
                .selectAll("text").style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");

            line_chart_g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y));


            /*
            let yScale = d3.scaleLinear().domain(d3.extent(data)).range([line_chart_height,0]).nice();
            let xScale = d3.scaleLinear().domain(d3.extent(date)).range([0,line_chart_width-60]).nice();
           
            let yAxis = d3.axisLeft(yScale).tickSize(-line_chart_height).tickPadding(10);
            let xAxis = d3.axisBottom(xScale).tickSize(310,0).ticks(4).tickFormat(d3.timeFormat('%x'))
            
            
            let yAxisG = line_chart.append('g').call(yAxis).attr('id','yAxis');
            let xAxisG = line_chart.append('g').call(xAxis).attr('transform', `translate(0,0)`).attr('id','xAxis');
            */


        }
        function update_bar_chart() {
            bar_chart.remove()
            bar_chart = d3.select('#bar_chart').append("svg").attr("width", 450).attr("height", 290);
            bar_chart_g = bar_chart.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var dicValues = Object.values(data_a);
            dicValues.sort(function (a, b) {
                return b - a;
            });

            var dataDic2 = {};
            var dataMatrix = [];

            for (var i = 0; i < Object.keys(data_a).length; i++) {
                for (var j = 0; j < Object.keys(data_a).length; j++) {
                    if (dicValues[i] == Object.values(data_a)[j]) {
                        dataDic2[Object.keys(data_a)[j]] = dicValues[i];
                        dataMatrix.push({ "station": Object.keys(data_a)[j], "population": dicValues[i] });
                    }
                }
            }
            population = dataMatrix;
            dataMatrix = dataMatrix.slice(0, 10);
            let innerHeight = 290 - margin.top - margin.bottom;
            let innerWidth = 450 - margin.left - margin.right;

            const yValue = dataMatrix => dataMatrix.station;
            const xValue = dataMatrix => dataMatrix.population;

            const yScale = d3.scaleBand().domain(dataMatrix.map(yValue)).range([0, innerHeight]).paddingInner(1);
            const xScale = d3.scaleLinear().domain([0, d3.max(dataMatrix, xValue)]).range([0, innerWidth]);

            const siFormat = d3.format('.2s');
            const xAxisTickFormat = tickValue => siFormat(tickValue).replace('G', 'B');

            let xAxis = d3.axisBottom(xScale).tickFormat(xAxisTickFormat).tickSize(-250);
            let yAxis = d3.axisLeft(yScale)

            bar_chart_g.selectAll('rect').data(dataMatrix).enter().append('rect').attr('fill', '#09c').attr('height', '15').attr('width', function (d) {
                return xScale(d.population);
            }).attr('x', '0').attr('y', function (d) {
                return yScale(d.station) - 7.5
            })
                .on("mouseover", function (d) {
                    d3.select(this).call((selection) => {
                        selection.attr('class', 'bar_chart_mouseover');
                    });
                    bar_chart_g.append("text").text(d.population).attr("x", '10').attr("y", yScale(d.station) - 10)
                        .attr('id', 'bar_text');
                })
                .on("mouseout", function (d) {
                    d3.select(this).call((selection) => {
                        selection.attr('class', '');
                    });
                    d3.select("#bar_text").remove();
                })


            let xAxisG = bar_chart_g.append('g').call(xAxis).attr('transform', `translate(0,250)`).attr('id', 'xAxis');
            let yAxisG = bar_chart_g.append('g').call(yAxis);
        }
        d3.json('./dataset/station_path.geojson', function (error, p) {
            //站的path
            setTimeout(() => {
                g.selectAll(null).data(p.features).enter().append("path")
                    .attr("d", function (d) {
                        return path(d);
                    })
                    .attr("class", "MRT")
            }, 500);
        });
        /*
        d3.json('./dataset/taipei.geojson', function (error, m) {
            map = m;
            svg.selectAll("path").data(m.features).enter().append("path").attr("d", path);

            d3.json('./dataset/station_path.geojson', function (error, p) {
                //站的path
                setTimeout(() => {

                    svg.selectAll(null).data(p.features).enter().append("path")
                        .attr("d", function (d) {
                            return path(d);
                        })
                        .attr("class", "MRT")
                }, 1000);
            });
        });
        */


        d3.csv('./dataset/MRT_total.csv', function (error, in_record) {
            
            MRT_record = in_record;
            //mrt
            d3.json('./dataset/station_position.geojson', function (error, point) {
                position = point;
                //站的位置
                setTimeout(() => {
                    g.selectAll("circle").data(point.features).enter().append("circle").attr('r', 5)
                        .attr('cx', function (d) { return projection(d.geometry.coordinates)[0] })
                        .attr('cy', function (d) { return projection(d.geometry.coordinates)[1] })
                        .attr('id', function (d) {
                            return d.properties.中文站名
                        })
                        .on("click", function (d) {
                            update_line_chart(d.properties.中文站名)
                            var circle = d3.select(this);
                            var cx = this.getAttribute('cx')*1;
                            var cy = this.getAttribute('cy')*1;
                            
                            clicked(d.properties.中文站名,cx,cy,d3.event.pageX,d3.event.pageY);
                        })
                        .on("mouseover", function (d) {
                            if(!click_status){
                                d3.select(this).call((selection) => {
                                selection.attr('r', '7');
                                });
                                g.append("text").text(d.properties.中文站名).attr("x", this.cx.animVal.value + 8).attr("y", this.cy.animVal.value + 8).attr('id', 'tooltip');
                            }
                        })
                        .on("mouseout", function (d) {
                            d3.select(this).call((selection) => {
                                selection.attr('r', '5');
                            });
                            d3.select("#tooltip").remove();
                        })
                    compute();
                }, 1000);

            });
            transform();
        });

        d3.select('#show_status').on('click', function () {
            if (d3.select(this).property("checked")) {
                d3.select('#time_b').attr('style', 'visibility:visible')
                use_compare = true
            }
            else {
                d3.select('#time_b').attr('style', 'visibility:hidden')
                use_compare = false
            }
            update()
        });
        d3.selectAll('.form-control').on('change', function () {
            var v = eval(d3.select(this).property('value'));
            var name = d3.select(this).property('name')
            switch (name) {
                case 's_y_a':
                    start_time_array_a[0] = v
                    break;
                case 's_m_a':
                    start_time_array_a[1] = v
                    break;
                case 's_d_a':
                    start_time_array_a[2] = v
                    break;
                case 'e_y_a':
                    end_time_array_a[0] = v
                    break;
                case 'e_m_a':
                    end_time_array_a[1] = v
                    break;
                case 'e_d_a':
                    end_time_array_a[2] = v
                    break;
                case 's_y_b':
                    start_time_array_b[0] = v
                    break;
                case 's_m_b':
                    start_time_array_b[1] = v
                    break;
                case 's_d_b':
                    start_time_array_b[2] = v
                    break;
                case 'e_y_b':
                    end_time_array_b[0] = v
                    break;
                case 'e_m_b':
                    end_time_array_b[1] = v
                    break;
                case 'e_d_b':
                    end_time_array_b[2] = v
                    break;

                default:
                    break;
            }
            update();
            //console.log(start_time_array_a,end_time_array_a,start_time_array_b,end_time_array_b)
        })
        /*
        d3.select('#menu').selectAll('.slider.item input').on('input', function (d) {
            var attr = d3.select(this).attr('name');
            if (attr == 'longitude') {
                state[attr] = 121.6 + 0.01 * this.value;
                console.log(state[attr]);
            }
            else if (attr == 'latitude') {
                state[attr] = 24.7 + 0.006 * this.value;
                console.log(state[attr]);
            }
            else {
                state[attr] = this.value;
            }
            update()
        });*/

    </script>

</body>

</html>